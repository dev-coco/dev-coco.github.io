/*!
  * ExcelFormulaBeautifier (https://github.com/AntoniotheFuture/ExcelFormulaBeautifier)
  * Licensed under GPL-3.0 License (https://raw.githubusercontent.com/AntoniotheFuture/ExcelFormulaBeautifier/master/LICENSE)
  */
var Operators=new Array("+","-","*","/","&"),Tabs="  ",StringVarName="_String_",Errors=new Array,FunctionInfos="",AllRows=new Array,DesAllRow=new Array,Strings=new Array;function ExcelFormulaBeautifier2(l){var e,n,s,r,t,o,w=new RegExp("\r\n","g"),A=new RegExp(Tabs,"g"),h=new RegExp("\\s","g"),g=new RegExp("\\(","g"),R=new RegExp("\\)","g"),i=new RegExp(",","g"),p=!0,a=new Array,u=new Array,f=new Array,y=0,c=new Array;if(Errors=new Array,AllRows=new Array,Strings=new Array,(l.split('"').length-1)%2==0){for(s=l.split('"'),r="",0,e=0;e<s.length;e++)p?""===s[e]?r+='"':(p=!p,r+=s[e]):""===s[e]?(r+='""',p=!p):(p=!p,r=r+'"'+StringVarName+Strings.length+'"',Strings.push(s[e]));if(a=(r=(r=(r=(r=(r=(r=r.replace(w,"")).replace(A,"")).replace(h,"")).replace(g,"( ")).replace(R,") ")).replace(i,", ")).split(" "),r.split("(").length!==r.split(")").length)return void Errors.push("102:Not match brackets,左右括号数量应相等");for(e=0;e<a.length;e++)if((t=a[e]).endsWith("(")){for(o=!1,0,n=0;n<ExFunction.length;n++)if(t.endsWith(ExFunction[n].Fname+"(")){o=!0;break}y<0&&(y=0),o?(AllRows.length>0&&(AllRows[AllRows.length-1][2]=1,c[c.length-1]=1),"Yes"===ExFunction[n].NewLine?(AllRows.push(new Array(y,t,1,y+1)),c.push(1)):(AllRows.push(new Array(y,t,0,y)),c.push(0)),y++,f[f.length-1]=f[f.length-1]+1,u.push(ExFunction[n].Args),f.push(0)):(c.push(0),AllRows.length>0?1===AllRows[AllRows.length-1][2]?(y=AllRows[AllRows.length-1][3],AllRows.push(new Array(y,t,0,y))):AllRows[AllRows.length-1][1]=AllRows[AllRows.length-1][1]+t:AllRows.push(new Array(0,t,0,0)))}else if(t.endsWith(")"))1===c[c.length-1]?(AllRows.push(new Array(y,t.substr(0,t.length-1),1,y)),y--,u.length>0&&f.length>0&&(f[f.length-1]=f[f.length-1]+1),AllRows.push(new Array(y,")",0,y))):(AllRows[AllRows.length-1][1]=AllRows[AllRows.length-1][1]+t,AllRows[AllRows.length-1][2]=0),c.pop();else if(t.endsWith(",")){if(0===c[c.length-1]){Errors.push("103:Invalid comma,无效的逗号:"+t);break}AllRows.length>0&&(y=AllRows[AllRows.length-1][3]),1===AllRows[AllRows.length-1][2]?AllRows.push(new Array(y,t,1,y)):(AllRows[AllRows.length-1][1]=AllRows[AllRows.length-1][1]+t,AllRows[AllRows.length-1][2]=1),u.length>0&&f.length>0&&(f[f.length-1]=f[f.length-1]+1)}}else Errors.push("101:Not match double quotes,双引号数量应为偶数")}function GetResult(l,e){var n,s="";for(n=0;n<AllRows.length;n++)AllRows[n][0]>0&&(s+=e.repeat(AllRows[n][0])),s+=AllRows[n][1],1===AllRows[n][2]&&(s+=l);for(n=0;n<Strings.length;n++)s=s.replace(StringVarName+n,Strings[n]);return s}function GetDes(l,e,n){var s,r,t,o,w="",A=new Array,h="";for(DesAllRow=new Array,s=0;s<AllRows.length;s++)if(h="",A.length>0&&(h=A[t=A.length-1][A[t].length-1]),o=!1,AllRows[s][1].endsWith("(")){for(r=0;r<ExFunction.length;r++)if(AllRows[s][1].endsWith(ExFunction[r].Fname+"(")){A.push(new Array);for(var g=ExFunction[r].Args.length;g>0;g--)A[A.length-1].push(ExFunction[r].Fname+":"+ExFunction[r].Args[g-1]);DesAllRow.push(new Array(0,0,"",AllRows[s][2],AllRows[s][3])),o=!0;break}o||DesAllRow.push(new Array(0,0,"",AllRows[s][2],AllRows[s][3]))}else AllRows[s][1].startsWith(")")?(DesAllRow.push(new Array(0,0,"",AllRows[s][2],AllRows[s][3])),AllRows[s][1].endsWith(",")&&A.length>0&&(h=A[t=A.length-1][A[t].length-1],DesAllRow[DesAllRow.length-1][2]=h,DesAllRow[DesAllRow.length-1][0]=AllRows[s][0],DesAllRow[DesAllRow.length-1][1]=AllRows[s][1].length,A[t].length>0?h.endsWith("]")||(A[t].pop(),0===A[t].length&&A.pop()):Errors.push("105:Too much args,函数参数太多"))):AllRows[s][1].endsWith(",")?(DesAllRow.push(new Array(AllRows[s][0],AllRows[s][1].length,h,AllRows[s][2],AllRows[s][3])),""!==h&&(A[t].length>0?h.endsWith("]")||(A[t].pop(),0===A[t].length&&A.pop()):Errors.push("105:Too much args,函数参数太多"))):(DesAllRow.push(new Array(AllRows[s][0],AllRows[s][1].length,h,AllRows[s][2],AllRows[s][3])),A.length>0&&A.pop());for(s=0;s<DesAllRow.length;s++)""!==DesAllRow[s][2]&&(w=w+e.repeat(DesAllRow[s][0])+n.repeat(DesAllRow[s][1]+2)+"--",w+=DesAllRow[s][2]),1===DesAllRow[s][3]&&(w+=l);return w}function GetErrors(){for(var l="",e=0;e<Errors.length;e++)l=l+Errors[e]+"\r\n";return l}"function"!=typeof String.prototype.startsWith&&(String.prototype.startsWith=function(l){return this.slice(0,l.length)===l}),"function"!=typeof String.prototype.endsWith&&(String.prototype.endsWith=function(l){return-1!==this.indexOf(l,this.length-l.length)}),"function"!=typeof String.prototype.repeat&&(String.prototype.repeat=function(l){for(var e="",n=0;n<l;n++)e+=this;return e});